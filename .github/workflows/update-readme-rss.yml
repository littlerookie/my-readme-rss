name: ğŸ•µï¸â€â™‚ï¸ Fetch upstream README and generate RSS

on:
  schedule:
    # æ¯å°æ—¶æ•´ç‚¹æ‰§è¡Œä¸€æ¬¡ï¼›ä¹Ÿå¯ä»¥æ”¹æˆ â€œ0 0 * * *â€ï¼ˆæ¯å¤©ï¼‰æˆ–å…¶ä»– cron è¡¨è¾¾å¼
    - cron: '0 * * * *'
  workflow_dispatch:   # æ‰‹åŠ¨è§¦å‘

jobs:
  build-feed:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä½ è‡ªå·±è¿™ä¸ªä»“åº“çš„ä»£ç 
      - uses: actions/checkout@v4
        with:
          persist-credentials: true  # è®©åé¢å¯ä»¥ git push

      # 2. æ‹‰å–ç›®æ ‡é¡¹ç›®çš„æœ€æ–° README.md
      - name: Fetch upstream README.md
        run: |
          curl -sL \
            https://raw.githubusercontent.com/tmgthb/Autonomous-Agents/main/README.md \
            > current.md

      # 3. å¯¹æ¯”ä¸Šä¸€æ¬¡çš„ç‰ˆæœ¬ï¼Œè‹¥æ— æ”¹åŠ¨åˆ™è·³è¿‡
      - name: Compare with previous
        run: |
          PREV=docs/last.md
          if [ -f "$PREV" ] && cmp -s current.md "$PREV"; then
            echo "No change, skipping."
            exit 0
          fi

      # 4. ç”Ÿæˆ RSS æ–‡ä»¶åˆ° docs/README.xml
      - name: Generate RSS feed
        run: |
          NOW=$(date -u +"%a, %d %b %Y %H:%M:%S GMT")
          CONTENT=$(sed 's/]]>/]]]]><![CDATA[>/g' current.md)
          cat > docs/README.xml <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0">
<channel>
  <title>Autonomous-Agents/README.md æ›´æ–°</title>
  <link>https://github.com/tmgthb/Autonomous-Agents/blob/main/README.md</link>
  <description>è®¢é˜… tmgthb/Autonomous-Agents README å…¨æ–‡æ›´æ–°</description>
  <item>
    <title>æ›´æ–°äº $NOW</title>
    <pubDate>$NOW</pubDate>
    <guid isPermaLink="false">README-$NOW</guid>
    <description><![CDATA[
$CONTENT
    ]]></description>
  </item>
</channel>
</rss>
EOF
          # ä¿å­˜æœ¬æ¬¡åŸæ–‡ï¼Œä¾›ä¸‹æ¬¡æ¯”å¯¹
          cp current.md docs/last.md

      # 5. æäº¤å¹¶æ¨é€è¿™äº›å˜åŒ–
      - name: Commit & Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/README.xml docs/last.md
          git diff --quiet || git commit -m "ğŸ“ è‡ªåŠ¨æ›´æ–° upstream README RSS" && git push
